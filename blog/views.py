from django.shortcuts import render
from django.http import HttpResponseRedirect
from utils.views import render_vurnelable
from blog.models import Post, Comment

def posts(request, query=None):
    if query:
        try:
            posts_db = Post.objects.filter(keywords__icontains=query)
        except Post.DoesNotExist:
            posts_db = None
    else:
        posts_db = Post.objects.all()
    context = {
        'posts': posts_db,
        'query': query
    }
    return render_vurnelable(request, 'blog/index.html', context)

def post_detailed(request, slug, post_id):
    if request.method == 'GET':
        try:
            context = {
                'post' : Post.objects.get(id=post_id)
            }
            try:
                comments = Comment.objects.filter(post__id=post_id)
            except Comment.DoesNotExist:
                comments = []
            context['comments'] = comments
            return render_vurnelable(request, 'blog/post_detailed.html', context)
        except Post.DoesNotExist:
            return render(request, 'blog/post_not_found.html')
    else:
        commenter_name = request.POST.get('commenter_name')
        comment = request.POST.get('new_comment').strip()
        comment_obj = Comment(name=commenter_name, content=comment, post=Post(id=post_id))
        comment_obj.save()
        return HttpResponseRedirect(request.path_info)